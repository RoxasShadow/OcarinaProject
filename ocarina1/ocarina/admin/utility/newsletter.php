<?php/* Permette di inviare newsletter a tutti gli utenti registrati */// Includo le classi principaliinclude_once "../../core/class.Ocarina.php";include_once "../../core/class.MySQL.php";include_once "../../core/class.Functions.php";include_once "../../etc/class.Email.php";include_once "../../rendering/config.php";// Istanzio le classi$cms = new Ocarina;$db = new MySQL;$func = new Functions;$email = new Emailer;/* Invia la newsletter */if(isset($_POST['invianewsletter'])) {	// Prelevo l'oggetto	$oggetto = $_POST['oggetto'];	// Prelevo il contenuto	$contenuto = $_POST['contenuto'];	// Prelevo l'email del mittente 	$mittente = $cms->email();	// Mi connetto al database	$db->connettidb();	// Prelevo tutti gli indirizzi email e spedisco	$query = $db->query("SELECT email FROM utenti");	while ($riga = $db->estrai($query)) {		$destinatario = $func->rescape($riga->email);		$email->email($mittente,$destinatario,$oggetto,$contenuto);	}	// Mi disconnetto dal databse	$db->disconnettidb();	// Aggiorno i log se sono attivi	if($cms->cmslog() == 1) {		$codice = $_COOKIE[$func->cookie()];		$azione = 'inviato una newsletter)';		$db->log($codice, $azione);	}	// Mando l' avviso	$text = 'La newsletter è stata inviata.';	$smarty->assign("titolo", "Invia newsletter");	$smarty->assign("cookie", $db->auth($_COOKIE[$func->cookie()]));	$smarty->assign("grado", $db->grado($_COOKIE[$func->cookie()]));	$smarty->assign("contents", $text);	$smarty->assign("url_cms", $cms->url_cms());	$smarty->assign("url_smartytpl", $cms->url_smartytpl());	$smarty->assign("cmsversion", $cms->cmsversion());	$smarty->display("admin/index/index.tpl");}$text = 'Tramite il seguente form puoi inviare una email a tutti gli utenti registrati.<br />Tieni conto che il mittente è l\'email che hai impostato in class.Ocarina.php.<br /><br /><div align="center"><form action="" method="post">Oggetto:<br /><input type="text" name="oggetto"><br /><br />Contenuto:<br />'.$func->textarea('contenuto', '').'<br /><input type="submit" name="invianewsletter" value="Invia"></form></div>';$smarty->assign("titolo", "Invia newsletter");$smarty->assign("cookie", $db->auth($_COOKIE[$func->cookie()]));$smarty->assign("grado", $db->grado($_COOKIE[$func->cookie()]));$smarty->assign("contents", $text);$smarty->assign("url_cms", $cms->url_cms());$smarty->assign("url_smartytpl", $cms->url_smartytpl());$smarty->assign("cmsversion", $cms->cmsversion());$smarty->display("admin/index/index.tpl");?>